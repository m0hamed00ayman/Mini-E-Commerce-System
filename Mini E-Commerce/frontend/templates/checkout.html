<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout - Mini E-Commerce</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-brand">
                <i class="fas fa-shopping-cart"></i>
                <span>Mini E-Commerce</span>
            </div>
            <div class="nav-links">
                <a href="/" class="nav-link"><i class="fas fa-home"></i> Home</a>
                <a href="/products" class="nav-link"><i class="fas fa-store"></i> Products</a>
                <a href="/cart" class="nav-link"><i class="fas fa-shopping-cart"></i> Cart</a>
                <a href="/add-product" class="nav-link"><i class="fas fa-plus-circle"></i> Add Product</a>
                <a href="/analytics/sales" class="nav-link"><i class="fas fa-chart-line"></i> Analytics</a>
            </div>
        </div>
    </nav>

    <main class="container">
        {% if success %}
        <div class="checkout-success">
            <div class="success-icon">
                <i class="fas fa-check-circle fa-4x"></i>
            </div>
            <h1>Order Confirmed!</h1>
            <p class="success-message">Thank you for your purchase. Your order has been successfully processed.</p>
            
            <div class="order-details">
                <div class="order-card">
                    <h3><i class="fas fa-receipt"></i> Order Details</h3>
                    <div class="order-info">
                        <div class="info-row">
                            <span>Order ID:</span>
                            <strong>#{{ order_id }}</strong>
                        </div>
                        <div class="info-row">
                            <span>Total Amount:</span>
                            <strong>${{ "%.2f"|format(total_amount) }}</strong>
                        </div>
                        <div class="info-row">
                            <span>Date:</span>
                            <span>{{ current_date }}</span>
                        </div>
                    </div>
                </div>
                
                <div class="next-steps">
                    <h3><i class="fas fa-shipping-fast"></i> What's Next?</h3>
                    <ul>
                        <li><i class="fas fa-envelope"></i> Order confirmation email sent</li>
                        <li><i class="fas fa-box"></i> Items will be prepared for shipping</li>
                        <li><i class="fas fa-truck"></i> Delivery within 3-5 business days</li>
                        <li><i class="fas fa-chart-line"></i> Analytics updated in real-time</li>
                    </ul>
                </div>
            </div>
            
            <div class="success-actions">
                <a href="/" class="btn btn-primary">
                    <i class="fas fa-home"></i> Return to Home
                </a>
                <a href="/products" class="btn btn-secondary">
                    <i class="fas fa-store"></i> Continue Shopping
                </a>
                <a href="/analytics/sales" class="btn btn-outline">
                    <i class="fas fa-chart-line"></i> View Analytics
                </a>
            </div>
            
            <div class="data-flow-info">
                <h3><i class="fas fa-project-diagram"></i> Data Flow After Purchase</h3>
                <div class="flow-steps">
                    <div class="flow-step">
                        <div class="step-icon">
                            <i class="fas fa-database"></i>
                        </div>
                        <div class="step-content">
                            <h4>1. SQL Server Update</h4>
                            <p>Sales record created in transactional database</p>
                        </div>
                    </div>
                    <div class="flow-step">
                        <div class="step-icon">
                            <i class="fas fa-sync-alt"></i>
                        </div>
                        <div class="step-content">
                            <h4>2. ETL Processing</h4>
                            <p>Airflow DAG processes the sale data</p>
                        </div>
                    </div>
                    <div class="flow-step">
                        <div class="step-icon">
                            <i class="fas fa-warehouse"></i>
                        </div>
                        <div class="step-content">
                            <h4>3. Data Warehouse</h4>
                            <p>Data transformed and loaded to warehouse</p>
                        </div>
                    </div>
                    <div class="flow-step">
                        <div class="step-icon">
                            <i class="fas fa-chart-bar"></i>
                        </div>
                        <div class="step-content">
                            <h4>4. Analytics Update</h4>
                            <p>Real-time analytics dashboard updated</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% else %}
        <div class="checkout-process">
            <div class="checkout-header">
                <h1><i class="fas fa-lock"></i> Secure Checkout</h1>
                <p>Complete your purchase in 3 simple steps</p>
                
                <div class="checkout-steps">
                    <div class="step active">
                        <div class="step-number">1</div>
                        <div class="step-label">Shipping</div>
                    </div>
                    <div class="step">
                        <div class="step-number">2</div>
                        <div class="step-label">Payment</div>
                    </div>
                    <div class="step">
                        <div class="step-number">3</div>
                        <div class="step-label">Confirmation</div>
                    </div>
                </div>
            </div>
            
            <div class="checkout-layout">
                <div class="checkout-form-section">
                    <form method="POST" action="/checkout" class="checkout-form" id="checkoutForm">
                        <div class="form-section">
                            <h3><i class="fas fa-user"></i> Contact Information</h3>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="name">Full Name *</label>
                                    <input type="text" id="name" name="name" required 
                                           placeholder="Enter your full name">
                                </div>
                                
                                <div class="form-group">
                                    <label for="email">Email Address *</label>
                                    <input type="email" id="email" name="email" required 
                                           placeholder="your@email.com">
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label for="phone">Phone Number</label>
                                <input type="tel" id="phone" name="phone" 
                                       placeholder="(123) 456-7890">
                            </div>
                        </div>
                        
                        <div class="form-section">
                            <h3><i class="fas fa-truck"></i> Shipping Address</h3>
                            
                            <div class="form-group">
                                <label for="address">Street Address *</label>
                                <input type="text" id="address" name="address" required 
                                       placeholder="123 Main Street">
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="city">City *</label>
                                    <input type="text" id="city" name="city" required 
                                           placeholder="New York">
                                </div>
                                
                                <div class="form-group">
                                    <label for="state">State *</label>
                                    <input type="text" id="state" name="state" required 
                                           placeholder="NY">
                                </div>
                                
                                <div class="form-group">
                                    <label for="zip">ZIP Code *</label>
                                    <input type="text" id="zip" name="zip" required 
                                           placeholder="10001">
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label for="country">Country *</label>
                                <select id="country" name="country" required>
                                    <option value="">Select Country</option>
                                    <option value="US" selected>United States</option>
                                    <option value="CA">Canada</option>
                                    <option value="UK">United Kingdom</option>
                                    <option value="AU">Australia</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-section">
                            <h3><i class="fas fa-credit-card"></i> Payment Method</h3>
                            
                            <div class="payment-options">
                                <label class="payment-option">
                                    <input type="radio" name="payment_method" value="credit_card" checked>
                                    <div class="option-content">
                                        <i class="fas fa-credit-card"></i>
                                        <span>Credit Card</span>
                                    </div>
                                </label>
                                
                                <label class="payment-option">
                                    <input type="radio" name="payment_method" value="paypal">
                                    <div class="option-content">
                                        <i class="fab fa-paypal"></i>
                                        <span>PayPal</span>
                                    </div>
                                </label>
                                
                                <label class="payment-option">
                                    <input type="radio" name="payment_method" value="debit_card">
                                    <div class="option-content">
                                        <i class="fas fa-credit-card"></i>
                                        <span>Debit Card</span>
                                    </div>
                                </label>
                            </div>
                            
                            <div id="creditCardDetails" class="card-details">
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="card_number">Card Number *</label>
                                        <input type="text" id="card_number" 
                                               placeholder="1234 5678 9012 3456">
                                    </div>
                                </div>
                                
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="expiry">Expiry Date *</label>
                                        <input type="text" id="expiry" 
                                               placeholder="MM/YY">
                                    </div>
                                    
                                    <div class="form-group">
                                        <label for="cvv">CVV *</label>
                                        <input type="text" id="cvv" 
                                               placeholder="123">
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label for="card_name">Name on Card *</label>
                                    <input type="text" id="card_name" 
                                           placeholder="John Doe">
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-actions">
                            <a href="/cart" class="btn btn-secondary">
                                <i class="fas fa-arrow-left"></i> Back to Cart
                            </a>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-lock"></i> Complete Purchase
                            </button>
                        </div>
                    </form>
                </div>
                
                <div class="checkout-summary-section">
                    <div class="order-summary">
                        <h3><i class="fas fa-shopping-bag"></i> Order Summary</h3>
                        
                        <div class="order-items">
                            {% for item in cart_items %}
                            <div class="order-item">
                                <div class="item-info">
                                    <span class="item-name">{{ item.name }}</span>
                                    <span class="item-quantity">Qty: {{ item.quantity }}</span>
                                </div>
                                <span class="item-price">${{ "%.2f"|format(item.discount_info.total) }}</span>
                            </div>
                            {% endfor %}
                        </div>
                        
                        <div class="order-totals">
                            <div class="total-row">
                                <span>Subtotal</span>
                                <span>${{ "%.2f"|format(subtotal) }}</span>
                            </div>
                            <div class="total-row">
                                <span>Discounts</span>
                                <span class="discount">-${{ "%.2f"|format(total_discount) }}</span>
                            </div>
                            <div class="total-row">
                                <span>Shipping</span>
                                <span>$0.00</span>
                            </div>
                            <div class="total-row">
                                <span>Estimated Tax</span>
                                <span>${{ "%.2f"|format(subtotal * 0.08) }}</span>
                            </div>
                            <div class="total-row grand-total">
                                <span>Total</span>
                                <span>${{ "%.2f"|format(final_total) }}</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="security-info">
                        <div class="security-header">
                            <i class="fas fa-shield-alt fa-2x"></i>
                            <div>
                                <h4>Secure Checkout</h4>
                                <p>Your payment is secure and encrypted</p>
                            </div>
                        </div>
                        <div class="security-features">
                            <div class="feature">
                                <i class="fas fa-lock"></i>
                                <span>256-bit SSL Encryption</span>
                            </div>
                            <div class="feature">
                                <i class="fas fa-user-shield"></i>
                                <span>PCI DSS Compliant</span>
                            </div>
                            <div class="feature">
                                <i class="fas fa-history"></i>
                                <span>Real-time Fraud Detection</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="analytics-preview">
                        <h4><i class="fas fa-chart-line"></i> Analytics Impact</h4>
                        <p>This purchase will immediately update:</p>
                        <ul>
                            <li>Sales analytics dashboard</li>
                            <li>Revenue calculations</li>
                            <li>Customer purchase history</li>
                            <li>Product performance metrics</li>
                        </ul>
                        <div class="data-flow">
                            <span class="flow-label">Data Flow:</span>
                            <span class="flow-path">Cart → SQL Server → Data Warehouse → Analytics</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
        
        <div class="checkout-features">
            <h2><i class="fas fa-cogs"></i> Checkout System Features</h2>
            <div class="features-grid">
                <div class="feature-card">
                    <i class="fas fa-database"></i>
                    <h3>SQL Server Integration</h3>
                    <p>Transactional data stored in SQL Server with ACID compliance</p>
                </div>
                <div class="feature-card">
                    <i class="fas fa-sync-alt"></i>
                    <h3>Real-time Processing</h3>
                    <p>Immediate inventory updates and analytics refresh</p>
                </div>
                <div class="feature-card">
                    <i class="fas fa-chart-bar"></i>
                    <h3>Analytics Pipeline</h3>
                    <p>Automated ETL to data warehouse for business intelligence</p>
                </div>
                <div class="feature-card">
                    <i class="fas fa-shield-alt"></i>
                    <h3>Secure Transactions</h3>
                    <p>Encrypted payment processing and data protection</p>
                </div>
            </div>
        </div>
    </main>

    <footer class="footer">
        <div class="footer-content">
            <p>&copy; 2024 Mini E-Commerce System. Checkout powered by Flask, SQL Server, and real-time analytics.</p>
        </div>
    </footer>

    <script>
        // Show/hide credit card details based on payment method
        const paymentOptions = document.querySelectorAll('input[name="payment_method"]');
        const cardDetails = document.getElementById('creditCardDetails');
        
        paymentOptions.forEach(option => {
            option.addEventListener('change', function() {
                if (this.value === 'credit_card' || this.value === 'debit_card') {
                    cardDetails.style.display = 'block';
                    // Make card fields required
                    document.getElementById('card_number').required = true;
                    document.getElementById('expiry').required = true;
                    document.getElementById('cvv').required = true;
                    document.getElementById('card_name').required = true;
                } else {
                    cardDetails.style.display = 'none';
                    // Remove required from card fields
                    document.getElementById('card_number').required = false;
                    document.getElementById('expiry').required = false;
                    document.getElementById('cvv').required = false;
                    document.getElementById('card_name').required = false;
                }
            });
        });
        
        // Form validation
        document.getElementById('checkoutForm').addEventListener('submit', function(event) {
            const email = document.getElementById('email').value;
            const phone = document.getElementById('phone').value;
            const selectedPayment = document.querySelector('input[name="payment_method"]:checked').value;
            
            // Email validation
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                alert('Please enter a valid email address');
                event.preventDefault();
                return;
            }
            
            // Phone validation (optional but if provided, validate)
            if (phone && !/^[\d\s\-\+\(\)]{10,}$/.test(phone.replace(/\s/g, ''))) {
                alert('Please enter a valid phone number');
                event.preventDefault();
                return;
            }
            
            // If credit/debit card selected, validate card details
            if ((selectedPayment === 'credit_card' || selectedPayment === 'debit_card') && 
                cardDetails.style.display !== 'none') {
                const cardNumber = document.getElementById('card_number').value.replace(/\s/g, '');
                const expiry = document.getElementById('expiry').value;
                const cvv = document.getElementById('cvv').value;
                const cardName = document.getElementById('card_name').value;
                
                // Simple card validation
                if (!/^\d{16}$/.test(cardNumber)) {
                    alert('Please enter a valid 16-digit card number');
                    event.preventDefault();
                    return;
                }
                
                if (!/^\d{2}\/\d{2}$/.test(expiry)) {
                    alert('Please enter expiry date in MM/YY format');
                    event.preventDefault();
                    return;
                }
                
                if (!/^\d{3,4}$/.test(cvv)) {
                    alert('Please enter a valid CVV (3 or 4 digits)');
                    event.preventDefault();
                    return;
                }
                
                if (!cardName.trim()) {
                    alert('Please enter the name on card');
                    event.preventDefault();
                    return;
                }
            }
            
            // Show loading
            const submitBtn = this.querySelector('button[type="submit"]');
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
            submitBtn.disabled = true;
        });
        
        // Format card number input
        document.getElementById('card_number')?.addEventListener('input', function(e) {
            let value = e.target.value.replace(/\s/g, '').replace(/\D/g, '');
            let formatted = '';
            
            for (let i = 0; i < value.length && i < 16; i++) {
                if (i > 0 && i % 4 === 0) {
                    formatted += ' ';
                }
                formatted += value[i];
            }
            
            e.target.value = formatted;
        });
        
        // Format expiry date input
        document.getElementById('expiry')?.addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            
            if (value.length >= 2) {
                value = value.substring(0, 2) + '/' + value.substring(2, 4);
            }
            
            e.target.value = value.substring(0, 5);
        });
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            // Trigger payment method change to set initial state
            const selectedPayment = document.querySelector('input[name="payment_method"]:checked');
            if (selectedPayment) {
                selectedPayment.dispatchEvent(new Event('change'));
            }
        });
    </script>
</body>
</html>